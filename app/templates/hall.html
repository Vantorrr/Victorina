<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Экран зала — Викторина</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body class="hall tg">
  <div class="appbar"><h1>Экран зала</h1></div>
  <div class="container">
    <div class="card">
      <div id="stage" class="stage">Ожидание…</div>
      <div id="timer" class="timer hidden">60</div>
      <div class="footer-note">Управление идёт из панели ведущего.</div>
    </div>
  </div>

  <script>
    // Telegram WebApp theme integration
    try {
      if (window.Telegram && window.Telegram.WebApp) {
        const wp = window.Telegram.WebApp;
        wp.expand();
        const tp = wp.themeParams || {};
        const map = {
          '--tg-bg': tp.bg_color,
          '--tg-bg-elev': tp.secondary_bg_color,
          '--tg-text': tp.text_color,
          '--tg-muted': tp.hint_color,
          '--tg-primary': tp.button_color,
          '--tg-primary-strong': tp.button_color,
          '--tg-border': tp.section_separator_color,
          '--tg-card': tp.section_bg_color,
        };
        for (const k in map) {
          if (map[k]) document.body.style.setProperty(k, map[k]);
        }
      }
    } catch (e) { /* noop */ }

    const stage = document.getElementById('stage');
    const timerEl = document.getElementById('timer');
    let countdownId = null;
    function startTimer(seconds) {
      clearInterval(countdownId);
      timerEl.classList.remove('hidden');
      let remain = seconds;
      timerEl.textContent = remain;
      countdownId = setInterval(() => {
        remain -= 1;
        if (remain <= 0) {
          timerEl.textContent = '0';
          clearInterval(countdownId);
          return;
        }
        timerEl.textContent = String(remain);
      }, 1000);
    }

    function stopTimer() {
      clearInterval(countdownId);
      timerEl.classList.add('hidden');
    }

    const proto = location.protocol === 'https:' ? 'wss' : 'ws';
    const ws = new WebSocket(`${proto}://${location.host}/ws/hall`);
    ws.onmessage = (evt) => {
      try {
        const msg = JSON.parse(evt.data);
        if (msg.type === 'slide') {
          // Если прилетит slide.image — покажем картинку, иначе текст
          if (msg.image) {
            stage.innerHTML = `<img src="${msg.image}" alt="slide" style="max-width:100%; border-radius:12px;"/>`;
          } else {
            stage.textContent = msg.text || 'Слайд';
          }
          stopTimer();
        }
        if (msg.type === 'question') {
          stage.textContent = `${msg.text}\n\n• ${((msg.options || []).join('\n• '))}`;
          startTimer(msg.seconds || 60);
        }
        if (msg.type === 'results') {
          stage.textContent = msg.text || 'Результаты';
          stopTimer();
        }
      } catch (e) {
        console.error('WS message parse error', e);
      }
    };
  </script>
</body>
</html>


